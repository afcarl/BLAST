function y = imatshCompiler(fnames, mediaRoot, origfname, shingleLen, shingleHop, beta, mixx)
# y = imatshCompiler(fnames, mediaRoot, origTrackName, shingleLen, shingleHop, [beta=2.0, mix=0])
# read imatshTrackDescriptions compile matshup
#
#inputs:
# fnames - track description filenames
# mediaRoot - root directory for media files
# origTrackName - the target track [wav]
# shingleLen - length of shingles in frames [22]
# shingleHop - hop size of shingles in frames [22]
# beta -source mix probability parameter [2.0]
# mixx - amount of original audio mix [0.5]
#
# Track descriptions are files of space-separated 4-tuples "d t o n\n"
#
# d: Euclidean distance
# t: imatchup time index (hop size units [1024])
# o: media time index (hop size units [1024])
# n: name of media file
#
# output:
#  wavefile of matshup
#
# Copyright (C) Michael A. Casey 2009
# Dartmouth College, All Rights Reserved

# Time parameters

if (nargin<7), mixx = 0.5;end # Original audio mix
if (nargin<6), beta = 2.0;end # Source mix probability parameter
if (nargin<5), shingleHop=22;end # Hop size of match segments
if (nargin<4), shingleLen=22;end # Length of match segments

hop=1024; % hop size of feature frames (sub-shingle hop)
framesz = hop; % length of feature frames (sub-shingle length)

# check original media
if(~exist(origfname))
  error("You really ought to have the original file be visible");
end



if(~iscell(fnames))
  error("fnames really ought to be a cell array");
end

numFiles=length(fnames);
Dists=[];Times=[];Offsets=[];Names={};
for file = 1:numFiles
				# Read file description into arrays
  [d,t,o,n] = textread(fnames{file}, "%f %d %d %s");
  #idx = find(t); # Always ignore time 0
  idx = 1:length(t);
  if(~isempty(idx))
    Dists = [Dists;d(idx)];
    Times = [Times;t(idx)];
    Offsets = [Offsets;o(idx)];
    Names = [Names;n(idx)'];
  end
endfor

# main compiler function
# for each target time index
T = max(Times);
outfid = fopen([fnames{1} '.raw'], 'wb','ieee-le');
for t = 0:shingleLen:T
				# Find all distances for current time index
  t_idx = find(Times==t);
  if(~isempty(t_idx))
    d = Dists(t_idx);
    o = Offsets(t_idx);    
				# Make probability distribution
    probs = exp( -beta * d ) ./ sum( exp( -beta * d) );
				# Get media at offset
    printf("t:%d ", t);
    fflush(1);
    z = wavread(origfname, [t*framesz+1 (t+shingleLen)*framesz]);
    [nr,nc] = size(z);
    if( nc > 1 )
      z = sum(z')' ./ sqrt(nc);
    endif
    y = zeros(shingleLen*framesz,1);
    for k=1:length(t_idx)
      printf("%f ", probs(k));
      fflush(1);
      thisfname = [mediaRoot filesep Names{t_idx(k)}];
				# FIXME: need some cross-fade logic here
      if(exist(thisfname))
	x = wavread(thisfname, [o(k)*framesz+1 (o(k)+shingleLen)*framesz]);
	[nr,nc] = size(x);
	if( nc > 1 )
	  x = sum(x')' ./ sqrt(nc);
	endif
	rmsOrig = sqrt(mean(z.^2));
	rmsThis = sqrt(mean(x.^2));
	if(rmsThis>eps)
	  amp = rmsOrig/rmsThis;
	else
	  amp = 0.0;
	endif
	if(length(x)<shingleLen*framesz)
	  x = [x;zeros(shingleLen*framesz-nr,1)];
	endif
	y = y + amp*probs(k)*x;
	clear x;
      else
	fprintf("CANNOT FIND WAVFILE: %s\n", thisfname);
      endif
    endfor
    printf("\n");
  endif
  if(size(z,1)<size(y,1))
    z=[z;zeros(size(y,1)-size(z,1),1)];
  endif
  yzL =  32768.0*( (1-mixx)*y + mixx*z );
  yzR =  32768.0*( mixx*y + (1-mixx)*z );
  fwrite(outfid, [yzL yzR]', 'short', 0, 'ieee-le');
endfor
fclose(outfid);

